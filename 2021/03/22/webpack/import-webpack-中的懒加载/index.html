<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=""><title>webpack - import() - webpack 中的懒加载 | 叁歌</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.1.5"><link rel="stylesheet" type="text/css" href="/css/dark.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/normalize.css/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script src="https://www.googletagmanager.com/gtag/js?id=G-HEVC7VFM0G" async></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());

gtag('config', 'G-HEVC7VFM0G');
</script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = 'https://hm.baidu.com/hm.js?' + '3b74b15709da4bba44d03cc55664915f';
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><script type="text/javascript" src="//cdn.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 5.3.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">webpack - import() - webpack 中的懒加载</h1><a id="logo" href="/.">叁歌</a><p class="description">To be the best of best.</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">webpack - import() - webpack 中的懒加载</h1><div class="post-meta">2021-03-22<span> | </span><span class="category"><a href="/categories/webpack/"> webpack  </a></span></div><div class="post-content"><h2 id="1-前言"><a href="#1-前言" class="headerlink" title="1. 前言"></a>1. 前言</h2><p>懒加载，是一种常见的优化网页性能的手段。我们可以将其理解为延时加载，即：真正需要用到某些逻辑的时候，再将这些逻辑下载并执行。<br>webpack 通过内部解析 <code>import()</code>  函数，默认支持了模块的懒加载。下面我们将从写法、加载执行原理两个方面来介绍 webpack 实现的懒加载方案。</p>
<h2 id="2-写法介绍"><a href="#2-写法介绍" class="headerlink" title="2. 写法介绍"></a>2. 写法介绍</h2><p>首先我们还是介绍下相关的写法，自一个最简单的 demo 说起。</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 入口 js</span></span><br><span class="line"><span class="keyword">import</span>(<span class="comment">/* webpackChunkName: &#x27;greeting&#x27; */</span> <span class="string">&#x27;./greeting&#x27;</span>).then(<span class="function">(<span class="params">&#123; sayHello &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  sayHello(<span class="string">&#x27;安宁&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// greeting.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> sayHello = <span class="function">(<span class="params">name</span>) =&gt;</span> <span class="built_in">console</span>.log(<span class="string">`Hello, <span class="subst">$&#123;name&#125;</span>`</span>)</span><br></pre></td></tr></table></figure>
<p>简单介绍下这编译前的两段代码：<br>我们的 <code>greeting</code>  模块 <code>export</code>  出一个 <code>sayHello</code> 的方法。我们的入口 js 中使用 <code>import()</code>  函数动态导入了 <code>greeting</code>  模块，并设置其 <code>chunkName</code>  为 <code>greeting</code> ，导入后调用 <code>sayHello</code>  方法并打印输出。</p>
<p>经过 webpack 编译打包之后，生成了入口的 <code>main.js</code> 和单独的 <code>greeting.js</code>  文件<br>在我们 html 模板中，则只是引入了 <code>main.js</code> ，由 <code>main.js</code>  去合理安排合适加载 <code>greeting.js</code> 。</p>
<p>这样的机制，让我们组织代码更加灵活，不想在首屏做的事情可以全部使用懒加载做到后置加载和执行，我们上述的例子只是简单地介绍语法，官网给出的例子更加能说明懒加载在优化方面的功能体现：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// button 加载</span></span><br><span class="line"><span class="keyword">const</span> button = <span class="built_in">document</span>.createElement(<span class="string">&#x27;button&#x27;</span>)</span><br><span class="line">button.innerHTML = <span class="string">&#x27;Click me and look at the console!&#x27;</span></span><br><span class="line"><span class="built_in">document</span>.body.appendChild(button)</span><br><span class="line"></span><br><span class="line"><span class="comment">// button 点击事件</span></span><br><span class="line">button.onclick = <span class="function">(<span class="params">e</span>) =&gt;</span></span><br><span class="line">  <span class="keyword">import</span>(<span class="comment">/* webpackChunkName: &quot;print&quot; */</span> <span class="string">&#x27;./print&#x27;</span>).then(<span class="function">(<span class="params"><span class="built_in">module</span></span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> print = <span class="built_in">module</span>.default</span><br><span class="line">    print()</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure>
<p>整体 button 的点击事件的代码存放在 print 模块中，该模块异步加载并执行。<br>连一个简单的事件都可以异步加载，操作空间是真的大….</p>
<h2 id="3-加载、执行原理"><a href="#3-加载、执行原理" class="headerlink" title="3. 加载、执行原理"></a>3. 加载、执行原理</h2><p>看过了使用时的语法，我们分别来盘一盘加载、执行的原理。</p>
<p>我们聚焦于 <code>entry</code> 加载 <code>greeting</code> 模块的语句：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">__webpack_require__</span><br><span class="line">  .e(<span class="comment">/*! import() | greeting */</span> <span class="string">&#x27;greeting&#x27;</span>)</span><br><span class="line">  .then(</span><br><span class="line">    __webpack_require__.bind(</span><br><span class="line">      __webpack_require__,</span><br><span class="line">      <span class="comment">/*! ./greeting */</span> <span class="string">&#x27;./amnhh/src/greeting.js&#x27;</span></span><br><span class="line">    )</span><br><span class="line">  )</span><br><span class="line">  .then(<span class="function">(<span class="params">&#123; sayHello &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">    sayHello(<span class="string">&#x27;安宁&#x27;</span>)</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure>
<p>这段代码整体可以分为三层：</p>
<ul>
<li><code>__webpack_require__.e(&#39;greeting&#39;)</code>  =&gt; 加载异步 chunk</li>
<li><code>.then(__webpack_require__(&#39;./xxx/greeting.js&#39;))</code>  =&gt; 导入模块</li>
<li><code>.then(() =&gt; &#123; // 拿到模块，使用模块 &#125;)</code>  =&gt; 使用模块</li>
</ul>
<p>有了这层认识之后，我们来看下相应的加载和执行。</p>
<h4 id="3-1-加载原理"><a href="#3-1-加载原理" class="headerlink" title="3.1 加载原理"></a>3.1 加载原理</h4><p>我们前面提到，真正到 html 中首屏加载的只有主文件，而其他的子模块则通过主文件自己选择合适的时机加载。所以加载的时机和方式比较关键，我们以此为切入点，带大家一步步看下如何加载。</p>
<p>首先以模块的名字 <code>greeting</code>  调用 <code>__webpack_require__.e</code>  方法:</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">;(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  __webpack_require__.f = &#123;&#125;</span><br><span class="line">  <span class="comment">// This file contains only the entry chunk.</span></span><br><span class="line">  <span class="comment">// The chunk loading function for additional chunks</span></span><br><span class="line">  __webpack_require__.e = <span class="function">(<span class="params">chunkId</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Promise</span>.all(</span><br><span class="line">      <span class="built_in">Object</span>.keys(__webpack_require__.f).reduce(<span class="function">(<span class="params">promises, key</span>) =&gt;</span> &#123;</span><br><span class="line">        __webpack_require__.f[key](chunkId, promises)</span><br><span class="line">        <span class="keyword">return</span> promises</span><br><span class="line">      &#125;, [])</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>
<p>该方法的整体作用，是使用 <code>__webpack_require__.f.j</code>  加载相应的异步 <code>chunk</code> ，在加载的过程中会产出和包装多个 <code>promise</code> 实例，将这些 <code>promise</code>  实例包裹到一个 <code>Promise.all</code> 中返回</p>
<p>在 <code>__webpack_require__.f.j</code>  中，先是生成了一个用于锁定 <code>chunk</code>  状态的 <code>promise</code> ，并保存好它的 <code>resolve</code>和 <code>reject</code>  方法，存于 <code>installedChunks</code>  中。</p>
<p><code>installedChunk</code>  变量为一个 <code>hashMap</code>  结构，用于存储当前<strong>加载完成</strong>和<strong>加载中</strong>的 <code>chunk</code> ， <code>key</code>  为 <code>chunkName</code>， <code>value</code>  有两种形式：</p>
<ul>
<li>a. <code>0</code> : 已经加载完成的 <code>chunk</code> ，会被记作 <code>0</code></li>
<li>b. <code>[resolve, reject, promise]</code>: 加载中的 <code>chunk</code>  会被暂存 <code>resolve</code>  和 <code>reject</code>  函数，用来外部改变锁定 <code>chunk</code>  加载过程的那个 <code>promise</code>  的状态。</li>
</ul>
<p>而后进入到 <code>__webpack_require__.l</code>  方法中，该方法主要负责新建 <code>&lt;script&gt;</code>  标签，使用 <code>jsonp</code>  促使浏览器去加载异步 <code>chunk</code>  对应的 <code>js</code>  资源。在资源加载执行完成后，如果需要销毁的话，会销毁这个 &lt;<code>script&gt;</code>  标签~</p>
<p>资源执行时，主体是一个类似以下的调用语句：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">webpackChunkWebpack.push([</span><br><span class="line">  [chunksIds],</span><br><span class="line">  &#123;</span><br><span class="line">    modulePath: <span class="function">(<span class="params">__webpack_exports__, webpack__require__</span>) =&gt;</span> moduleValue,</span><br><span class="line">  &#125;,</span><br><span class="line">])</span><br></pre></td></tr></table></figure>
<p>和我们平时所见的 <code>jsonp callback</code>  获取数据的模式有所不同。<br><code>webpack</code>  通过对 <code>webpackChunkWebpack</code>  这个 <code>global</code>  下的数组的 <code>push</code>  方法的代理，使异步 <code>chunk</code>  在调用 <code>push</code>  方法时，以 <code>[chunkIds, modulesMap]</code>  的参数触发到 <code>webpackJsonpCallback</code>  方法的执行。</p>
<p>在 <code>webpackJsonpCallback</code>  中，将传来的 <code>chunksIds</code>  和 <code>modulesMap</code>  进行处理：</p>
<ul>
<li><code>chunkIds</code> : 找到前面提到的 <code>installedChunks</code>  里对应 <code>chunk</code>  的 <code>[resolve, reject, promise]</code><ul>
<li>调用 resolve 函数，使 chunk 的加载解除锁定</li>
<li><code>installedChunks[chunk]</code>  赋值为 0，标记为已经加载完成</li>
</ul>
</li>
<li><code>modulesMap</code> : 将 <code>modules</code>  挨个记录到 <code>__webpack_require__.m</code>  中，让我们可以通过 <code>__webpack_require__</code>  方法对这个模块进行加载。</li>
</ul>
<p>上述工作全部做好后，其实异步 <code>chunk</code>  的加载工作已全部完成，每个 <code>chunk</code>  的 <code>promise</code>  也因为在 <code>webpackJsonpCallback</code>  中手动 <code>resolve</code>  而变为 <code>fullfilled</code>  状态， <code>Promise.all</code>  进入到了下一层！</p>
<p>至此，加载的过程结束。</p>
<h4 id="3-2-执行原理"><a href="#3-2-执行原理" class="headerlink" title="3.2 执行原理"></a>3.2 执行原理</h4><p>执行原理较为简单，在加载 <code>chunk</code>  的 <code>jsonpcallback</code>  里，将所有的 modules 全部存放到<code>__webpack_require__.m</code>  后，我们就可以使用 <code>__webpack_require__</code>  将模块的拿到，对应的前面所说的第二层：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">__webpack_require__</span><br><span class="line">  .e(<span class="string">&#x27;greeting&#x27;</span>)</span><br><span class="line">  <span class="comment">// bingo! 就是这里</span></span><br><span class="line">  .then(</span><br><span class="line">    __webpack_require__.bind(__webpack_require__, <span class="string">&#x27;./amnhh/src/greeting.js&#x27;</span>)</span><br><span class="line">  )</span><br><span class="line">  .then(<span class="function">(<span class="params">&#123; sayHello &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">    sayHello(<span class="string">&#x27;安宁&#x27;</span>)</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure>
<p>在 <code>__webpack_require__</code>  调用后，拿到了 <code>greeting</code>  模块对应的代码，也就进入到了第三层，使用模块的这一层，无需多言。</p>
<h2 id="4-结束"><a href="#4-结束" class="headerlink" title="4. 结束"></a>4. 结束</h2><p>简单的用手稿和画的图，来收个尾：<br><img src="/images/async-import-1.png" alt="异步chunk 的加载、执行过程.svg"></p>
<p><a href="/files/webpack-async-chunk-draft.pdf">webpack-async-chunk-draft</a></p>
</div><div class="tags"><a href="/tags/javascript/"><i class="fa fa-tag"></i>javascript</a><a href="/tags/%E5%B7%A5%E7%A8%8B%E5%8C%96/"><i class="fa fa-tag"></i>工程化</a><a href="/tags/webpack/"><i class="fa fa-tag"></i>webpack</a></div><div class="post-nav"><a class="next" href="/2021/02/02/webpack/Compilation-%E6%9E%84%E5%BB%BA%E5%8A%A8%E4%BD%9C%E7%9A%84%E6%89%A7%E8%A1%8C%E8%80%85%E5%92%8C%E7%AE%A1%E7%90%86%E8%80%85/">webpack - Compilation -- 构建动作的执行者和管理者</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Jquery/">Jquery</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Virtual-DOM/">Virtual DOM</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Vue/">Vue</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/babel/">babel</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/javascript/">javascript</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/leetcode/">leetcode</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/webpack/">webpack</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%89%8D%E7%AB%AF%E5%9B%BD%E9%99%85%E5%8C%96/">前端国际化</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/">数据结构</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%97%A7%E5%8D%9A%E5%AE%A2/">旧博客</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%AE%97%E6%B3%95/">算法</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BD%91%E7%BB%9C/">网络</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/">读书笔记</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/%E6%9D%82%E8%B0%88/" style="font-size: 15px;">杂谈</a> <a href="/tags/HTTP/" style="font-size: 15px;">HTTP</a> <a href="/tags/HTTP-%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97/" style="font-size: 15px;">HTTP 权威指南</a> <a href="/tags/%E3%80%8A%E4%B8%8D%E5%9C%A8%E4%BB%96%E6%96%B9%E3%80%8B/" style="font-size: 15px;">《不在他方》</a> <a href="/tags/%E5%89%8D%E7%AB%AF/" style="font-size: 15px;">前端</a> <a href="/tags/js/" style="font-size: 15px;">js</a> <a href="/tags/You-Don-t-Know-Javascript/" style="font-size: 15px;">You Don't Know Javascript</a> <a href="/tags/%E3%80%8A%E5%A4%A9%E6%89%8D%E5%9C%A8%E5%B7%A6-%E7%96%AF%E5%AD%90%E5%9C%A8%E5%8F%B3%E3%80%8B/" style="font-size: 15px;">《天才在左 疯子在右》</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" style="font-size: 15px;">数据结构</a> <a href="/tags/%E5%9F%BA%E6%9C%AC%E5%8A%9F/" style="font-size: 15px;">基本功</a> <a href="/tags/javascript/" style="font-size: 15px;">javascript</a> <a href="/tags/%E5%B7%A5%E7%A8%8B%E5%8C%96/" style="font-size: 15px;">工程化</a> <a href="/tags/leetcode/" style="font-size: 15px;">leetcode</a> <a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 15px;">算法</a> <a href="/tags/http/" style="font-size: 15px;">http</a> <a href="/tags/rfc/" style="font-size: 15px;">rfc</a> <a href="/tags/uri/" style="font-size: 15px;">uri</a> <a href="/tags/%E7%BC%96%E8%AF%91/" style="font-size: 15px;">编译</a> <a href="/tags/%E4%B8%A4%E5%91%A8%E8%87%AA%E5%88%B6%E8%84%9A%E6%9C%AC%E8%AF%AD%E8%A8%80/" style="font-size: 15px;">两周自制脚本语言</a> <a href="/tags/jquery/" style="font-size: 15px;">jquery</a> <a href="/tags/%E6%8A%80%E6%9C%AF%E9%92%BB%E7%A0%94/" style="font-size: 15px;">技术钻研</a> <a href="/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" style="font-size: 15px;">读书笔记</a> <a href="/tags/%E5%9F%BA%E7%A1%80/" style="font-size: 15px;">基础</a> <a href="/tags/%E5%89%8D%E7%AB%AF%E8%BF%9B%E9%98%B6/" style="font-size: 15px;">前端进阶</a> <a href="/tags/%E5%89%8D%E7%AB%AF%E5%9B%BD%E9%99%85%E5%8C%96/" style="font-size: 15px;">前端国际化</a> <a href="/tags/%E7%BD%91%E7%BB%9C/" style="font-size: 15px;">网络</a> <a href="/tags/typescript/" style="font-size: 15px;">typescript</a> <a href="/tags/Array-%E6%96%B9%E6%B3%95/" style="font-size: 15px;">Array 方法</a> <a href="/tags/%E5%89%8D%E7%AB%AF%E5%9F%BA%E7%A1%80/" style="font-size: 15px;">前端基础</a> <a href="/tags/virtual-dom/" style="font-size: 15px;">virtual dom</a> <a href="/tags/%E9%98%9F%E5%88%97/" style="font-size: 15px;">队列</a> <a href="/tags/%E6%95%B0%E7%BB%84/" style="font-size: 15px;">数组</a> <a href="/tags/algorithm/" style="font-size: 15px;">algorithm</a> <a href="/tags/sort/" style="font-size: 15px;">sort</a> <a href="/tags/webpack/" style="font-size: 15px;">webpack</a></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2021 <a href="/." rel="nofollow">叁歌.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="/js/copycode.js" successtext="复制成功!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.css"></div></body></html>